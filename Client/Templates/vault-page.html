{% extends "base.html" %}

{% block title %}{% endblock %}

{% block content %}
<div class="container justify-content-center">
    <h2 style="text-align: center">{{vault.title}}</h2>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mt-3" id="vault-navbar">
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 justify-content-center">
                <li class="nav-item"><a class="nav-link active" aria-current="page" href=""
                                        data-bs-toggle="modal" data-bs-target="#descriptionModal">
                    Description</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href=""
                                        data-bs-toggle="modal" data-bs-target="#newGemModal">
                    Add New Gem</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Search The Vault</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Filter contents</a></li>
                {% if vault.type == "private" %}
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Make Public</a></li>
                {% else %}
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Produce Shared Key</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>
    <div class="container-flex d-flex flex-wrap justify-content-center">
    {% for gem in gems %}
    <div id="card{{gem.title}}" class="card m-2" style="flex: 0 0 calc(25% - 2rem); max-width: calc(25% - 2rem);">
        <div class="card-header">
            <nav class="navbar bg-body-tertiary" style="padding: 0">
                <div class="btn-group" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-primary">Copy</button>
                  <button type="button" class="btn btn-primary">Edit</button>
                  <button type="button" class="btn btn-primary">Tags</button>
                </div>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{loop.index}}">Delete</button>
                </nav>
        </div>
            <div class="card-body">
            <h5 class="card-title">{{gem.title}}</h5>
            <p class="card-text">{{gem.preview}}</p>
            </div>
    </div>
    <div class="modal fade" id="deleteModal{{loop.index}}" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel1">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            Are you sure you want to delete <strong>{{gem.title}}</strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger">Delete</button>
            </div>
            </div>
      </div>
    </div>
    {% endfor %}
    </div>
    </div>
</div>
<div class="modal fade"  id="descriptionModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Vault's description</h1>
                <button type="button" class="btn-close" id="closeUpdate" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="text" class="form-control" id="description" name="description" value="{{vault.description}}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="updateButton" class="btn btn-primary"
                        data-bs-dismiss="modal" disabled>Update</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade"  id="newGemModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">New Gem</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeNewGem"></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <label for="new-gem-title" class="col-form-label" id="new-title-label">Title:</label>
                    <input type="text" class="form-control" id="new-gem-title" name="new-gem-title">
                    <label for="new-gem-content" class="col-form-label">Content:</label>
                    <textarea class="form-control" id="new-gem-content" name="new-gem-content"></textarea>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="addButton" class="btn btn-primary"
                        data-bs-dismiss="modal" disabled>Add</button>
            </div>
        </div>
    </div>
</div>

<script id="delete-buttons">
// Add click event listener to all delete buttons
document.querySelectorAll('.btn-danger').forEach(button => {

  button.addEventListener('click', event => {

    // Get title from parent modal
    const modal = button.closest('.modal');
    const title = modal.querySelector('.modal-title').textContent;

    // Send delete request
    fetch('/delete-gem', {
      method: 'POST',
      body: JSON.stringify({
            gemTitle:
       })
    })
    .then(response => {
      if(response.ok) {

        // Close modal
        const modalInstance = bootstrap.Modal.getInstance(modal);
        modalInstance.hide();

        // Remove card
        const card = document.getElementById(`card${title}`);
        card.remove();
      }
    })

  });

});
</script>
<script id="add-gem-events">


const addButton = document.getElementById('addButton');
const gemTitle = document.getElementById('new-gem-title');
const gemContent = document.getElementById('new-gem-content');

const closeButton = document.getElementById('closeNewGem');

closeButton.addEventListener('click', () => {
    gemTitle.value = "";
    gemContent.value = "";
});

function checkInputs() {
    fetch('/check-new-gem-title', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}',
        gemTitle: gemTitle.value
      })
    })
    .then(response => {
    if(response.status == 200) {
        if(gemTitle.value.length == 0 || gemContent.value.length == 0) {
            addButton.disabled = true;
        } else {
            addButton.disabled = false;
        }
        document.getElementById('new-title-label').innerHTML = "Title:"
    }
    else if(response.status == 409){
        addButton.disabled = true;
        document.getElementById('new-title-label').innerHTML = "Title (Make sure it's new):"
    }
    })
    .catch(error => {
      console.log('Error:', error);
    });
}


gemTitle.addEventListener('input', checkInputs);
gemContent.addEventListener('input', checkInputs);


addButton.addEventListener('click', () => {
    const newGemTitle = document.getElementById('new-gem-title').value;
    const newGemContent = document.getElementById('new-gem-content').value;

    fetch('/add-new-gem', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}',
        newGemTitle: newGemTitle,
        newGemContent: newGemContent
      })
    })
    .then(response => {

      // Create card
      const card = document.createElement('div');
      card.classList.add('card', 'm-2');
      card.style.flex = "0 0 calc(25% - 2rem)";
      card.style.maxWidth = "calc(25% - 2rem)";

      // Create header
      const header = document.createElement('div');
      header.classList.add('card-header');

      // Create nav
      const nav = document.createElement('nav');
      nav.classList.add('navbar', 'bg-body-tertiary');
      nav.style.padding = 0;

      // Create button group
      const btnGroup = document.createElement('div');
      btnGroup.classList.add('btn-group');
      btnGroup.setAttribute('role', 'group');
      btnGroup.setAttribute('aria-label', 'Basic example');

      // Add buttons
      const copyBtn = document.createElement('button');
      copyBtn.classList.add('btn', 'btn-primary');
      copyBtn.textContent = 'Copy';

      const editBtn = copyBtn.cloneNode(true);
      editBtn.textContent = 'Edit';

      const tagsBtn = copyBtn.cloneNode(true);
      tagsBtn.textContent = 'Tags';

      btnGroup.appendChild(copyBtn);
      btnGroup.appendChild(editBtn);
      btnGroup.appendChild(tagsBtn);

      // Create delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm');
      deleteBtn.textContent = 'Delete';

      // Add elements to nav
      nav.appendChild(btnGroup);
      nav.appendChild(deleteBtn);

      // Add nav to header
      header.appendChild(nav);

      // Add header to card
      card.appendChild(header);

    // Create card body
        const body = document.createElement('div');
        body.classList.add('card-body');

        // Create title
        const title = document.createElement('h5');
        title.classList.add('card-title');
        title.textContent = newGemTitle;

        // Create preview text
        const preview = document.createElement('p');
        preview.classList.add('card-text');
        preview.textContent = newGemContent;

        // Add elements to body
        body.appendChild(title);
        body.appendChild(preview);

        // Add body to card
        card.appendChild(body);

          // Append new card
          document.querySelector('.container-flex').appendChild(card);

        gemTitle.value = "";
        gemContent.value = "";
    })
    .catch(error => {
      console.log('Error:', error);
    });
  });
</script>
<script id="orgainzation-needed">

const description = document.getElementById('description');
const updateButton = document.getElementById('updateButton');

const closeUpdate = document.getElementById('closeUpdate');

updateButton.addEventListener('click', () => {


    const updatedDesc = document.getElementById('description').value;

    fetch('/update-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}',
        description: updatedDesc
      })
    })
    .then(response => {
      updateButton.disabled = true;
    })
    .catch(error => {
      console.log('Error:', error);
    });
  });

  closeUpdate.addEventListener('click', () => {
    fetch('/check-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}'
      })
    })
    .then(response => response.text())
        .then(data => {
      description.value = data;
      updateButton.disabled = true;
    })
    .catch(error => {
      console.log('Error:', error);
    });
  });

description.addEventListener('input', () => {
    fetch('/check-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}'
      })
    })
    .then(response => response.text())
        .then(data => {
      if(description.value !== data && description.value.length > 0) {
        updateButton.disabled = false;
      } else {
        updateButton.disabled = true;
      }
    })
    .catch(error => {
      console.log('Error:', error);
    });

});
</script>
<script id="spread-navbar">


const nav = document.getElementById('vault-navbar');
  const navItems = nav.querySelectorAll('li');

  function spreadItems() {
    const navWidth = nav.offsetWidth;
    const itemCount = navItems.length;
    const itemWidth = navWidth / itemCount;

    navItems.forEach(item => {
      item.style.width = `${itemWidth}px`;
      item.style.textAlign = 'center';
    });
  }

  spreadItems();

  window.addEventListener('resize', spreadItems);
</script>
{% endblock %}