{% extends "base.html" %}

{% block title %}{% endblock %}

{% block content %}
<div class="container justify-content-center">
    <h2 style="text-align: center">{{vault.title}}</h2>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mt-3" id="vault-navbar">
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0 justify-content-center">
                <li class="nav-item"><a class="nav-link active" aria-current="page" href=""
                                        data-bs-toggle="modal" data-bs-target="#descriptionModal">
                    Description</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#" id="newgemlink">
                    Add New Gem</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Search The Vault</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Filter contents</a></li>
                {% if vault.type == "private" %}
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Make Public</a></li>
                {% else %}
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="#">
                    Produce Shared Key</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>
    <div class="container-flex d-flex flex-wrap justify-content-center">
    {% for gem in gems %}
    <div class="card m-2" style="flex: 0 0 calc(25% - 2rem); max-width: calc(25% - 2rem);">
        <div class="card-header">
            <nav class="navbar bg-body-tertiary" style="padding: 0">
                <div class="btn-group" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-primary">Copy</button>
                  <button type="button" class="btn btn-primary">Edit</button>
                  <button type="button" class="btn btn-primary">Tags</button>
                </div>
                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{loop.index}}">Delete</button>
                </nav>
        </div>
            <div class="card-body">
            <h5 class="card-title">{{gem.title}}</h5>
            <p class="card-text">{{gem.preview}}</p>
            </div>
    </div>
    <div class="modal fade" id="deleteModal{{loop.index}}" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel1">Confirm Delete</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            Are you sure you want to delete <strong>{{gem.title}}</strong>? This action cannot be undone.
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="deleteGem('{{gem.title}}')">Delete</button>
            </div>
            </div>
      </div>
    </div>
    {% endfor %}
    </div>
    </div>
</div>
<div class="modal fade"  id="descriptionModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Vault's description</h1>
                <button type="button" class="btn-close" id="closeUpdate" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="text" class="form-control" id="description" name="description" value="{{vault.description}}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="updateButton" class="btn btn-primary"
                        data-bs-dismiss="modal" disabled>Update</button>
            </div>
        </div>
    </div>
</div>
<!---
<script>
const modal = bootstrap.Modal(document.getElementById('descriptionModal'));

modal.addEventListener('shown.bs.modal', () => {

    const new = document.getElementById('newgemlink');
    new.disabled = true;

});
</script>
--->
<script>
    function deleteGem(gemTitle) {

      fetch('/delete-gem', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          gemTitle: gemTitle
          vaultTitle: {{vault.title}}
        })
      })
      .then(response => {
        if(response.ok) {
          document.getElementById(`deleteModal${gemTitle}`).closest('.card').remove();
        }
      })
      .catch(error => {
        console.log('Error:', error);
      });

    }
</script>
<script>

const description = document.getElementById('description');
const updateButton = document.getElementById('updateButton');

const closeUpdate = document.getElementById('closeUpdate');

updateButton.addEventListener('click', () => {


    const updatedDesc = document.getElementById('description').value;

    fetch('/update-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}',
        description: updatedDesc
      })
    })
    .then(response => {
      updateButton.disabled = true;
    })
    .catch(error => {
      console.log('Error:', error);
    });
  });

  closeUpdate.addEventListener('click', () => {
    fetch('/check-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}'
      })
    })
    .then(response => response.text())
        .then(data => {
      description.value = data;
      updateButton.disabled = true;
    })
    .catch(error => {
      console.log('Error:', error);
    });
  });

description.addEventListener('input', () => {
    fetch('/check-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        vaultTitle: '{{vault.title}}'
      })
    })
    .then(response => response.text())
        .then(data => {
      if(description.value !== data && description.value.length > 0) {
        updateButton.disabled = false;
      } else {
        updateButton.disabled = true;
      }
    })
    .catch(error => {
      console.log('Error:', error);
    });

});
</script>
<script>
const nav = document.getElementById('vault-navbar');
  const navItems = nav.querySelectorAll('li');

  function spreadItems() {
    const navWidth = nav.offsetWidth;
    const itemCount = navItems.length;
    const itemWidth = navWidth / itemCount;

    navItems.forEach(item => {
      item.style.width = `${itemWidth}px`;
      item.style.textAlign = 'center';
    });
  }

  spreadItems();

  window.addEventListener('resize', spreadItems);
</script>
{% endblock %}